/*
 * jQuery UI Nested Sortable
 * v 1.3.5 / 21 jun 2012
 * http://mjsarfatti.com/code/nestedSortable
 *
 * Depends on:
 *	 jquery.ui.sortable.js 1.8+
 *
 * Copyright (c) 2010-2012 Manuele J Sarfatti
 * Licensed under the MIT License
 * http://www.opensource.org/licenses/mit-license.php
 */
(function(a){a.widget("mjs.nestedSortable",a.extend({},a.ui.sortable.prototype,{options:{tabSize:20,disableNesting:"mjs-nestedSortable-no-nesting",errorClass:"mjs-nestedSortable-error",listType:"ol",maxLevels:0,protectRoot:!1,rootID:null,rtl:!1,isAllowed:function(a,b){return!0}},_create:function(){this.element.data("sortable",this.element.data("nestedSortable"));if(!this.element.is(this.options.listType))throw new Error("nestedSortable: Please check the listType option is set to your actual list type");return a.ui.sortable.prototype._create.apply(this,arguments)},destroy:function(){return this.element.removeData("nestedSortable").unbind(".nestedSortable"),a.ui.sortable.prototype.destroy.apply(this,arguments)},_mouseDrag:function(b){this.position=this._generatePosition(b),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs);if(this.options.scroll){var c=this.options,d=!1;this.scrollParent[0]!=document&&this.scrollParent[0].tagName!="HTML"?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-b.pageY<c.scrollSensitivity?this.scrollParent[0].scrollTop=d=this.scrollParent[0].scrollTop+c.scrollSpeed:b.pageY-this.overflowOffset.top<c.scrollSensitivity&&(this.scrollParent[0].scrollTop=d=this.scrollParent[0].scrollTop-c.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-b.pageX<c.scrollSensitivity?this.scrollParent[0].scrollLeft=d=this.scrollParent[0].scrollLeft+c.scrollSpeed:b.pageX-this.overflowOffset.left<c.scrollSensitivity&&(this.scrollParent[0].scrollLeft=d=this.scrollParent[0].scrollLeft-c.scrollSpeed)):(b.pageY-a(document).scrollTop()<c.scrollSensitivity?d=a(document).scrollTop(a(document).scrollTop()-c.scrollSpeed):a(window).height()-(b.pageY-a(document).scrollTop())<c.scrollSensitivity&&(d=a(document).scrollTop(a(document).scrollTop()+c.scrollSpeed)),b.pageX-a(document).scrollLeft()<c.scrollSensitivity?d=a(document).scrollLeft(a(document).scrollLeft()-c.scrollSpeed):a(window).width()-(b.pageX-a(document).scrollLeft())<c.scrollSensitivity&&(d=a(document).scrollLeft(a(document).scrollLeft()+c.scrollSpeed))),d!==!1&&a.ui.ddmanager&&!c.dropBehaviour&&a.ui.ddmanager.prepareOffsets(this,b)}this.positionAbs=this._convertPositionTo("absolute");var e=this.placeholder.offset().top;if(!this.options.axis||this.options.axis!="y")this.helper[0].style.left=this.position.left+"px";if(!this.options.axis||this.options.axis!="x")this.helper[0].style.top=this.position.top+"px";for(var f=this.items.length-1;f>=0;f--){var g=this.items[f],h=g.item[0],i=this._intersectsWithPointer(g);if(!i)continue;if(h!=this.currentItem[0]&&this.placeholder[i==1?"next":"prev"]()[0]!=h&&!a.contains(this.placeholder[0],h)&&(this.options.type=="semi-dynamic"?!a.contains(this.element[0],h):!0)){a(h).mouseenter(),this.direction=i==1?"down":"up";if(this.options.tolerance!="pointer"&&!this._intersectsWithSides(g))break;a(h).mouseleave(),this._rearrange(b,g),this._clearEmpty(h),this._trigger("change",b,this._uiHash());break}}var j=this.placeholder[0].parentNode.parentNode&&a(this.placeholder[0].parentNode.parentNode).closest(".ui-sortable").length?a(this.placeholder[0].parentNode.parentNode):null,k=this._getLevel(this.placeholder),l=this._getChildLevels(this.helper),m=this.placeholder[0].previousSibling?a(this.placeholder[0].previousSibling):null;if(m!=null)while(m[0].nodeName.toLowerCase()!="li"||m[0]==this.currentItem[0]||m[0]==this.helper[0]){if(!m[0].previousSibling){m=null;break}m=a(m[0].previousSibling)}var n=this.placeholder[0].nextSibling?a(this.placeholder[0].nextSibling):null;if(n!=null)while(n[0].nodeName.toLowerCase()!="li"||n[0]==this.currentItem[0]||n[0]==this.helper[0]){if(!n[0].nextSibling){n=null;break}n=a(n[0].nextSibling)}var o=document.createElement(c.listType);return this.beyondMaxLevels=0,j!=null&&n==null&&(c.rtl&&this.positionAbs.left+this.helper.outerWidth()>j.offset().left+j.outerWidth()||!c.rtl&&this.positionAbs.left<j.offset().left)?(j.after(this.placeholder[0]),this._clearEmpty(j[0]),this._trigger("change",b,this._uiHash())):m!=null&&(c.rtl&&this.positionAbs.left+this.helper.outerWidth()<m.offset().left+m.outerWidth()-c.tabSize||!c.rtl&&this.positionAbs.left>m.offset().left+c.tabSize)?(this._isAllowed(m,k,k+l+1),m.children(c.listType).length||m[0].appendChild(o),e&&e<=m.offset().top?m.children(c.listType).prepend(this.placeholder):m.children(c.listType)[0].appendChild(this.placeholder[0]),this._trigger("change",b,this._uiHash())):this._isAllowed(j,k,k+l),this._contactContainers(b),a.ui.ddmanager&&a.ui.ddmanager.drag(this,b),this._trigger("sort",b,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(b,c){this.beyondMaxLevels&&(this.placeholder.removeClass(this.options.errorClass),this.domPosition.prev?a(this.domPosition.prev).after(this.placeholder):a(this.domPosition.parent).prepend(this.placeholder),this._trigger("revert",b,this._uiHash()));for(var d=this.items.length-1;d>=0;d--){var e=this.items[d].item[0];this._clearEmpty(e)}a.ui.sortable.prototype._mouseStop.apply(this,arguments)},serialize:function(b){var c=a.extend({},this.options,b),d=this._getItemsAsjQuery(c&&c.connected),e=[];return a(d).each(function(){var b=(a(c.item||this).attr(c.attribute||"id")||"").match(c.expression||/(.+)[-=_](.+)/),d=(a(c.item||this).parent(c.listType).parent(c.items).attr(c.attribute||"id")||"").match(c.expression||/(.+)[-=_](.+)/);b&&e.push((c.key||b[1])+"["+(c.key&&c.expression?b[1]:b[2])+"]"+"="+(d?c.key&&c.expression?d[1]:d[2]:c.rootID))}),!e.length&&c.key&&e.push(c.key+"="),e.join("&")},toHierarchy:function(b){function f(b){var d=(a(b).attr(c.attribute||"id")||"").match(c.expression||/(.+)[-=_](.+)/);if(d){var e={id:d[2]};return a(b).children(c.listType).children(c.items).length>0&&(e.children=[],a(b).children(c.listType).children(c.items).each(function(){var a=f(this);e.children.push(a)})),e}}var c=a.extend({},this.options,b),d=c.startDepthCount||0,e=[];return a(this.element).children(c.items).each(function(){var a=f(this);e.push(a)}),e},toArray:function(b){function g(b,f,h){var i=h+1,j,k;a(b).children(c.listType).children(c.items).length>0&&(f++,a(b).children(c.listType).children(c.items).each(function(){i=g(a(this),f,i)}),f--),j=a(b).attr(c.attribute||"id").match(c.expression||/(.+)[-=_](.+)/);if(f===d+1)k=c.rootID;else{var l=a(b).parent(c.listType).parent(c.items).attr(c.attribute||"id").match(c.expression||/(.+)[-=_](.+)/);k=l[2]}return j&&e.push({item_id:j[2],parent_id:k,depth:f,left:h,right:i}),h=i+1,h}var c=a.extend({},this.options,b),d=c.startDepthCount||0,e=[],f=2;return e.push({item_id:c.rootID,parent_id:"none",depth:d,left:"1",right:(a(c.items,this.element).length+1)*2}),a(this.element).children(c.items).each(function(){f=g(this,d+1,f)}),e=e.sort(function(a,b){return a.left-b.left}),e},_clearEmpty:function(b){var c=a(b).children(this.options.listType);c.length&&!c.children().length&&c.remove()},_getLevel:function(a){var b=1;if(this.options.listType){var c=a.closest(this.options.listType);while(c&&c.length>0&&!c.is(".ui-sortable"))b++,c=c.parent().closest(this.options.listType)}return b},_getChildLevels:function(b,c){var d=this,e=this.options,f=0;return c=c||0,a(b).children(e.listType).children(e.items).each(function(a,b){f=Math.max(d._getChildLevels(b,c+1),f)}),c?f+1:f},_isAllowed:function(b,c,d){var e=this.options,f=a(this.domPosition.parent).hasClass("ui-sortable")?!0:!1,g=this.placeholder.closest(".ui-sortable").nestedSortable("option","maxLevels");!e.isAllowed(b,this.placeholder)||b&&b.hasClass(e.disableNesting)||e.protectRoot&&(b==null&&!f||f&&c>1)?(this.placeholder.addClass(e.errorClass),g<d&&g!=0?this.beyondMaxLevels=d-g:this.beyondMaxLevels=1):g<d&&g!=0?(this.placeholder.addClass(e.errorClass),this.beyondMaxLevels=d-g):(this.placeholder.removeClass(e.errorClass),this.beyondMaxLevels=0)}})),a.mjs.nestedSortable.prototype.options=a.extend({},a.ui.sortable.prototype.options,a.mjs.nestedSortable.prototype.options)})(jQuery);var list_reorder={initialised:!1,init:function(a,b){this.element=a,this.url=b,a.nestedSortable({disableNesting:"no-nest",forcePlaceholderSize:!0,handle:"i.icon-move",helper:"clone",items:"li",listType:"ul",maxLevels:MENU_LEVEL,opacity:.6,placeholder:"placeholder",revert:250,tabSize:25,tolerance:"pointer",toleranceElement:"> div",update:function(a,b){item_id=get_number_from_string(b.item.attr("id"));try{parent_id=b.item.parent().parent().attr("id"),parent_id==undefined?parent_id=0:parent_id=get_number_from_string(parent_id)}catch(c){parent_id=0}try{prev_id=get_number_from_string(b.item.prev().attr("id"))}catch(c){prev_id=0}try{next_id=get_number_from_string(b.item.next().attr("id"))}catch(c){next_id=0}jQuery.ajax({type:"POST",url:list_reorder.url,data:{node_id:item_id,parent_id:parent_id,prev_id:prev_id,next_id:next_id,authenticity_token:AUTH_TOKEN},dataType:"script",beforeSend:function(a){attachLoading("body")},error:function(a,b,c){alert(c)},complete:function(a,b){removeLoading("body")}})}}),this.initialised=!0}};